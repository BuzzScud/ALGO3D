# CLLM PHP Extension Makefile

PHP_CONFIG = php-config
PHPIZE = phpize

# Get PHP configuration
PHP_INCLUDE = $(shell $(PHP_CONFIG) --includes)
PHP_EXTENSION_DIR = $(shell $(PHP_CONFIG) --extension-dir)

# Compiler flags
CFLAGS = -Wall -Wextra -g -O2 -fPIC $(PHP_INCLUDE)
CFLAGS += -I../include -I../algorithms/include -I../math/include

# Linker flags
LDFLAGS = -L.. -L../algorithms -L../math/lib
LDFLAGS += -lcllm -lalgorithms -lcrystallinemath
LDFLAGS += -Wl,-rpath,'$$ORIGIN/..'

# Source files
SOURCES = cllm_extension.c
OBJECTS = $(SOURCES:.c=.o)
TARGET = cllm.so

.PHONY: all clean install test

all: $(TARGET)

$(TARGET): $(OBJECTS)
	@echo "Building PHP extension..."
	$(CC) -shared $(OBJECTS) $(LDFLAGS) -o $(TARGET)
	@echo "✓ Extension built: $(TARGET)"

%.o: %.c
	@echo "Compiling $<..."
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	@echo "Cleaning..."
	rm -f $(OBJECTS) $(TARGET)
	rm -f *.lo *.la
	rm -rf .libs
	@echo "✓ Clean complete"

install: $(TARGET)
	@echo "Installing extension to $(PHP_EXTENSION_DIR)..."
	sudo cp $(TARGET) $(PHP_EXTENSION_DIR)/
	@echo "✓ Extension installed"
	@echo ""
	@echo "Add to php.ini:"
	@echo "  extension=cllm.so"

test: $(TARGET)
	@echo "Running demo..."
	LD_LIBRARY_PATH=..:../math/lib:$$LD_LIBRARY_PATH php -d extension=./$(TARGET) demo.php

test-api: $(TARGET)
	@echo "Starting REST API server..."
	@echo "Server will run on http://localhost:8080"
	@echo "Press Ctrl+C to stop"
	LD_LIBRARY_PATH=..:../math/lib:$$LD_LIBRARY_PATH php -S localhost:8080 -d extension=./$(TARGET) rest_api.php

help:
	@echo "CLLM PHP Extension Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all      - Build the extension (default)"
	@echo "  clean    - Remove build artifacts"
	@echo "  install  - Install extension to PHP extension directory"
	@echo "  test     - Run demo script"
	@echo "  test-api - Start REST API server"
	@echo "  help     - Show this help"
	@echo ""
	@echo "Usage:"
	@echo "  make              # Build extension"
	@echo "  make test         # Run demo"
	@echo "  make test-api     # Start API server"
	@echo "  make install      # Install system-wide"